@model List<Logic.Cashed.Contract.Models.CategoryModel>
@{
    ViewBag.Title = "Категории";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<button class="showcheckboxes btn btn-outline-secondary btn-sm">Выбрать</button>
<button class="hidecheckboxes btn btn-outline-secondary btn-sm" hidden>Убрать выделение</button>
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th class="checkbox-cell" hidden>
                <input type="checkbox" class="toggle-all-chechboxes"/>
            </th>
            <th>
                Номер
            </th>
            <th>
                Имя
            </th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Count; i++)
        {
            <tr data-id="@Model[i].Id">
                <td class="checkbox-cell" hidden>
                    <input type="checkbox" class="category-checkbox" data-id="@Model[i].Id"/>
                </td>
                <td>@Model[i].Id</td>
                <td>
                    @Html.ActionLink(Model[i].Name, "Edit", new { id = Model[i].Id }, new { @class = "edit-item-link" })
                </td>
            </tr>
        }
    </tbody>
</table>
@Html.ActionLink("Добавить", "Add", "Category", null, 
    new { id = "categoriesLink", @class = "btn btn-outline-primary btn-sm" })
<button class="delete-button btn btn-outline-danger btn-sm" hidden>Удалить</button>

@section Scripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            activateLink("#categoriesLink");

            $(".showcheckboxes").click(showCheckboxes);
            $(".hidecheckboxes").click(hideCheckboxes);
            $(".toggle-all-chechboxes").change(toggleAllCheckboxes);
            $(".category-checkbox").change(categoryCheckboxChanged);
            $(".delete-button").click(deleteCategories);
        });

        function showCheckboxes() {
            $(".checkbox-cell").removeAttr("hidden");
            $(".hidecheckboxes").removeAttr("hidden");
            $(".showcheckboxes").attr("hidden", "hidden");
        }

        function hideCheckboxes() {
            $("input[type=checkbox]").prop("checked", false);
            categoryCheckboxChanged();
            $(".checkbox-cell").attr("hidden", "hidden");
            $(".showcheckboxes").removeAttr("hidden");
            $(".hidecheckboxes").attr("hidden", "hidden");
        }

        function toggleAllCheckboxes(event) {
            if ($(".toggle-all-chechboxes:checked").length) {
                $(".category-checkbox").prop("checked", true);
            } else {
                $(".category-checkbox").prop("checked", false);
            }
            categoryCheckboxChanged();
        }

        function categoryCheckboxChanged() {
            if ($(".category-checkbox:checked").length)
                $(".delete-button").removeAttr("hidden");
            else
                $(".delete-button").attr("hidden", "hidden");
        }

        function deleteCategories() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("Delete", "Category")',
                contentType: "application/json; charset=utf-8",
                data: { idList: JSON.stringify(getDeleteIdList()) },
                dataType: "json",
                success: function (data) {
                    deleteRows(data);
                },
                error: function () { alert('Failure'); }
            });
        }

        function getDeleteIdList() {
            var chk = $(".category-checkbox:checked");
            var ids = chk.map(function (index, item) {
                return +$(item).attr("data-id");
            });
            var idList = [];
            for (var i = 0; i < ids.length; i++) {
                idList[i] = +ids[i];
            }
            console.log(idList);
            return idList;
            return ids;
        }

        function deleteRows(ids) {
            for (var i = 0; i < ids.length; i++) {
                var tr = $("tr[data-id=" + ids[i] + "]");
                console.log(tr);
                tr.remove();
            }
            categoryCheckboxChanged();
        }
    </script>

}

